
<!DOCTYPE html>
<html lang="zh-tw">
<head>
<!--meta http-equiv="refresh" content="60"-->    
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="">
<title>出差狀況查詢</title>

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

<style>
        body {
            padding-top: 54px;
        }
        
        a{
	margin: 10px;
        }
    
        .form-group {
            text-align: left;
        }
        
        img.img-responsive {
            height: 400px;
        }
        
        @media (min-width: 992px) {
            body {
                padding-top: 56px;
            }
        }
        
        @media (max-width: 980px) {
            img.img-responsive {
                height: 250px;
            }
        }
        
        @media (max-width: 480px) {
            img.img-responsive {
                height: 100px;
            }
        }
    </style>

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KH6W3QV');</script>

</head>
<body>   
<div class="container">
<div class="row">
<div class="col-lg-12 text-center">
<h1 class="mt-5">出差修改</h1>
<a href="./出差登記.html">出差登記</a>
<a href="./備註更改.html">備註更改</a>
<hr>
<div class="form-group col-xs-12">
</div>  
<div id="test"></div>
<div class="form-group col-xs-12">
<!-- button type="button" id="AllSearch" class="btn btn-primary ">全部查詢</button-->
</div>
<div class="form-group col-xs-12">
<table class="table table-striped" >
<thead>
<tr>
<th>編號</th>
<th>姓名</th>
<th>電話</th>
<th>出發時間</th>
<th>車型</th>
<th>出差地</th>
<th>同行者</th>
<th>目前狀態</th>
</tr>
</thead>
<tbody id="dataView">
    <!-- SendAllQuery(data)資料show出來-->
</tbody>
</table>
    
<div id="Revise" class="form-group col-xs-8">
    <!-- show全部資料-->
</div>
    
</div>
</div>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script>
    //時間format
    Date.prototype.format =function(format){
		var o = {
			"M+" : this.getMonth()+1, //month
			"d+" : this.getDate(), //day
			"h+" : this.getHours(), //hour
			"m+" : this.getMinutes(), //minute
			"s+" : this.getSeconds(), //second
			"q+" : Math.floor((this.getMonth()+3)/3), //quarter
			"S" : this.getMilliseconds() //millisecond
		}
		if(/(y+)/.test(format)) format=format.replace(RegExp.$1,
			(this.getFullYear()+"").substr(4- RegExp.$1.length));
		for(var k in o)if(new RegExp("("+ k +")").test(format))
			format = format.replace(RegExp.$1,
				RegExp.$1.length==1? o[k] :
					("00"+ o[k]).substr((""+ o[k]).length));
		return format;
        }
    //查詢全部人員
        $(function() {
            //$('#AllSearch').click(function(e) {
                    var data = {
                        'name': "1",
                        'phone': 123,
                        'action': 'query1'
                        }
                    SendAllQuery(data);
            //});
        });
        function AllhandleData(response) {
            var content = '';
            var Revise = ' ';
            response.forEach(element => {
                        var [no,name,phone,time, car,location,together,fettle] = element.data;
                        var index = element.index;
                        content +=
                            `
                            <tr>
                            <td>${no}</td>
                            <td>${name}</td>
                            <td>${phone}</td>
                            <td>${new Date(time).format("hh:mm")}</td>
                            <td>${car}</td>
                            <td>${location}</td>
                            <td>${together}</td>
                            <td  class="status">${fettle}</td>
                            <td>
                                ${fettle !== '出差中' ? '-' :
                                `<button type="button" id="come" onclick="updateStatusAll(${index}, this)" class="btn btn-primary">回公司</button>`
                                }
                            </td>
                            <td>
                                 ${fettle !== '出差中' ? '-' :
                                    `<button type="button"  onclick="updateDataAll(${index}, this)" class="btn btn-primary" id="set">修改</button>`
                                 }
                            </td>
                            </tr>
                            `
        });
        if (content) {
          document.getElementsByClassName('table-striped')[0].style.display ='table'; 
        } else {
          alert('查無資料');
        }
        var dataView = document.getElementById('dataView');
        dataView.innerHTML = content;
        var RView = document.getElementById('Revise');
        RView.innerHTML = "";
    }
    
    function SendAllQuery(data){
      $.ajax({
        type: "post",
       url: "https://script.google.com/macros/s/AKfycbyaPcAameJDwDNSm9EwHmpaL5ZCxj8ixur0t3JIupA1xUb-T1y95x-EIQQbBfjwJscg9w/exec",
        data: data,
        dataType: "JSON",
        success: function (response) {
        console.log(response);
        AllhandleData(response);
          $('#name').val('');
          $('#phone').val(''); 
        }
      });
    }
    
    //修改狀態"可使用"
    function updateStatusAll(index, that){
      var data = {
        action: 'delete',
        index: index+2,
      };
      $.ajax({
        type: "post",
        url: "https://script.google.com/macros/s/AKfycbyaPcAameJDwDNSm9EwHmpaL5ZCxj8ixur0t3JIupA1xUb-T1y95x-EIQQbBfjwJscg9w/exec",
        data: data,
        dataType: "JSON",
        success: function (response) {
            $(function() {
                        var cdata = {
                        'name': "1",
                        'phone': 123,
                        'action': 'query1'
                        }
                        SendAllQuery(cdata);
            }); 
           if(response === 'success'){
            $(that).parent().siblings('.status').text('可使用');
            $(that).remove();
            
          } else {
            alert('更新失敗！');
          }
        }
      }); 
    }
  
    //修改人員資料
    function RehandleData(response) {
            var content = '';
            var ReviseEle = '';
            response.forEach(element => {
                        var [no,name,phone,time, car,location,together,fettle] = element.data;
                        var index = element.index;
                        content +=
                            `
                            <tr>
                            <td>${no}</td>
                            <td>${name}</td>
                            <td>${phone}</td>   
                            <td>${new Date(time).format("hh:mm")}</td>
                            <td>${car}</td>
                            <td>${location}</td>
                            <td>${together}</td>
                            <td class="status">${fettle}</td>
                            <td>
                                <button type="button" id='Rebtn' class="btn btn-primary">完成</button>
                            </td>
                            </tr>
                            `
                            ReviseEle+=
                            `   
                                <hr>
                                <div style="text-align:left;" class="form-group col-xs-5">
                                <table border="1" width="150"  style="border-collapse:collapse" >
                                <thead>
                                <tr>
                                <th>車型</th>
                                <th>狀況</th>
                                </tr>
                                </thead>
                                <tbody id="carNowView">
                                <!-- 目前車況 -->
                                </tbody>
                                </table>
                                </div>
                             
                           <div style="text-align:left;" class="form-group col-xs-6">
                                <div>  
                                <input type=hidden id="changeindex" value=${index} >
                                <br>
                                車型
                                <br>
                                <input type="text" id="changecar" style="width:100px;" value=${car} disabled="disabled" >
                                <select id="changeCarSelect"></select>  
                                </div>  
                                <br>
                                人員 
                                <input type="text" class="form-control" id="changename" value=${name} >
                                <br>
                                電話
                                <input type="text" class="form-control" id="changephone" value=${phone} >
                                <br>
                                <div>
                                時間 
                                <br>
                                <input type="time" name="usr_time" id="changetime" value=${new Date(time).format("hh:mm")}>
                                </div>
                                <br>
                                出差地 
                                <input type="text" class="form-control" id="changelocation" value=${location} >
                                <br>
                                同行者
                                <input type="text" class="form-control" id="changetogether" value=${together} >
                            </div>
                            <div id="carNote"></div>
                            `
                            });
        if (content) {
          document.getElementsByClassName('table-striped')[0].style.display ='table'; 
        } else {
          alert('查無資料');
        }
        var dataView = document.getElementById('dataView');
        dataView.innerHTML = content;
        var RView = document.getElementById('Revise');
        RView.innerHTML = ReviseEle;
        
        //#carNote代入車輛狀況資料
        $(function(){
        $("#changeCarSelect").change(function(e){
        var status = true;  
        order = $(this).val();       
        var notedata = {
        'noteCar': order,
        'action': 'noteSelection'    
        }
        sendNoteData(notedata)
        });
        });
        function sendNoteData(data){
        $.ajax({
        type: "post",
        url: "https://script.google.com/macros/s/AKfycbyaPcAameJDwDNSm9EwHmpaL5ZCxj8ixur0t3JIupA1xUb-T1y95x-EIQQbBfjwJscg9w/exec",
        data: data,
        async:false,
        dataType: "JSON",
        success: function (response) {
        var content = '';
        response.forEach(element => {
        var [car,mileage,month,fettle] = element.data;
        content +=
        `
        <label style = "display:none" id = "carFettle"> ${fettle}</label>
        `
        })
        var dataView = document.getElementById('carNote');
        dataView.innerHTML = content;
        }
        });
        }
        
        //車輛目前狀態表
        var cdata = {
        'action': 'carNow'
        }
        carNow(cdata);   
        function carNow(data){
        $.ajax({
        type: "post",
        url: "https://script.google.com/macros/s/AKfycbyaPcAameJDwDNSm9EwHmpaL5ZCxj8ixur0t3JIupA1xUb-T1y95x-EIQQbBfjwJscg9w/exec",
        data: data,
        dataType: "JSON",
        success: function(response) { 
        var content = '';
        response.forEach(element => {
        var [car,,,fettle] = element.data;
        content +=
        `
        <tr>
        <td>${car}</td>
        <td>${fettle}</td>
        </tr>
        `
        })
        var dataView = document.getElementById('carNowView');
        dataView.innerHTML = content;
        }
        });
        }  
        
        //點完修改後的select選項
        var selectdata = {
                'action': 'selection'
            }
        selection(selectdata);
        
        //修改資料回傳
         $(function() {
            $('#Rebtn').click(function(e) {
                var status = true;
                var index = $('#changeindex').val();
                var phone= $('#changephone').val();
                var car = $('#changecar').val(); 
                var name = $('#changename').val(); 
                var time = $('#changetime').val(); 
                var location = $('#changelocation').val(); 
                var together = $('#changetogether').val(); 
                var a = $('#carFettle').text();
                var b=String(a);
                var c=String(' 可使用');
                
                console.log(index);
                console.log(car);
                console.log(phone);
                console.log(name);
                console.log(time);
                console.log(location);
                console.log(together);
                $('input').focus(function(){
                    $(this).css('border','');
                });
                if(name == ''){
                    $('#changename').css('border','1px solid #ff0000');
                    status = false;
                }
                if(location == ''){
                    $('#changelocation').css('border','1px solid #ff0000');
                    status = false;
                }
                
                if(b == c){
                console.log('true')
                }else
                {   
                alert('車輛出差中');
                console.log('false')
                status = false;
                }
                
                if(status){
                var currentdate = new Date();
                var filltime = currentdate.getFullYear() + "/"
                + (currentdate.getMonth() + 1) + "/"
                + currentdate.getDate() + "  "
                + time
                
                var data = {
                    'name': name,
                    'time': filltime,
                    'phone':phone,
                    'car':car,
                    'location': location,
                    'together':together,
                    'index':index, 
                    'action': 'changeData'
                }
                    updateChangeData(data);
                    setTimeout(function(){window.location.reload();}, 4000);
                }
            });
        });
    }
    $(function() {
            $('#set').click(function(e) {
                var selectdata = {
                'action': 'selection'
            }
            selection(selectdata);        
            });
     });
     
     //修該資料回傳
     function updateChangeData(data){
      $.ajax({
        type: "post",
        url: "https://script.google.com/macros/s/AKfycbyaPcAameJDwDNSm9EwHmpaL5ZCxj8ixur0t3JIupA1xUb-T1y95x-EIQQbBfjwJscg9w/exec",
        data: data,
        dataType: "JSON",
        success: function (response) {
          if(response === 'success'){
            alert('修改成功');
          } else {
            alert('更新失敗');
          }
        }
      }); 
    }
    
    
    //set資料到指定index
    function updateSetData(index, that){
      var data = {
        action: 'Resive',
        index: index+1,
      };
      $.ajax({
        type: "post",
        url: "https://script.google.com/macros/s/AKfycbyaPcAameJDwDNSm9EwHmpaL5ZCxj8ixur0t3JIupA1xUb-T1y95x-EIQQbBfjwJscg9w/exec",
        data: data,
        dataType: "JSON",
        success: function (response) {
          RehandleData(response) 
        }
      });
    } 
     
    //點選修改帶出資料  
    function updateDataAll(index, that){
      var data = {
        action: 'Resive',
        index: index+1,
      };
      $.ajax({
        type: "post",
        url: "https://script.google.com/macros/s/AKfycbyaPcAameJDwDNSm9EwHmpaL5ZCxj8ixur0t3JIupA1xUb-T1y95x-EIQQbBfjwJscg9w/exec",
        data: data,
        dataType: "JSON",
        success: function (response) {
          RehandleData(response)  
        }
      });
    }
    
    //帶入sheet1的車型資料,選擇後調整changecar的Value
    function selection(selectdata){
    $.ajax({
    type: "post",
    url: "https://script.google.com/macros/s/AKfycbyaPcAameJDwDNSm9EwHmpaL5ZCxj8ixur0t3JIupA1xUb-T1y95x-EIQQbBfjwJscg9w/exec",
    data: selectdata,
    dataType: "JSON",
    success: function(response) { 
    var content = ''
    response.forEach(element => {
    var [car] = element.data;
    content +=
    `<option value= ${car} >${car}</option>`
    })
    var dataView = document.getElementById('changeCarSelect');
    dataView.innerHTML = content;
    $(function(){
    $('#changeCarSelect').change(function(){
        let sltValue=$(this).val();
        $('#changecar').val(sltValue);
      });
     }); 
    }   
    });   
    }  
    
  </script>
 
</body>
</html>
